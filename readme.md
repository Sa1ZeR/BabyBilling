# Проект BabyBilling

# Инструкция по запуску:
0) если проект был запущен до, то выполните скрипт clear_data `sh clear_data.sh` (linux)
1) если ОС Linux, то необходимо вызвать скрипт init_for_linux `sh init_for_linux.sh` (Связано это из-за особенностей образов от bitnami)
2) запустить все сервисы `docker-compose up -d`

# Используемые технологии
- Spring Boot
- Spring Data Jpa
- Spring Cloud
- Spring Api Gateway
- Spring Eureka
- QueryDSL
- Kafka
- Redis

## Коротко о фичах

- у всех пользователей пароль 123456
- пользователь с правами менеджера 79554014636
- Добавлен новый сервис CallGenerator, который занимается генерацией cdr в многопоточном режиме (его можно масштабировать горизонтально, так как блокировки сделаны при помощи Redis)
- В сервисах используется Redis для кеширования данных 
- для CDR сервиса есть профиль dev, который отключает слушанье cdr записей, но включает возможность передать файлы напрямую, положив их в папку cdr
- транзакции пользователей можно получить при помощи апи у cdr сервиса (все параметры запроса опциональны. Это получилось достигнуть при помощи query dsl)
- добавлен свой новый тариф - Новинка. Чтобы протестировать фичу расширения тарифов
- заполнение таблиц происходит при помощи миграция(используется как java миграция, так и sql миграции)
- пополнение баланса происходит каждые 5 секунд для рандомных пользователей
- Swagger доступен по http://localhost:5000/swagger/index.html (можно переключаться между схемами благодаря api gateway) (ВАЖНО: дождитесь загрузки всех сервисов + их регистрации)
- При помощи API Gateway можно использовать один адрес для доступа к API (http://localhost:5000/имясервиса/api/...)
- CDR содержит локальную базу данных H2, но можно посмотреть все транзакции абонентов при помощи API CDR (список эндпоинтов можно посмотреть в Swagger) Фильтры опциональны, сделано это при помощи querydsl
- docker-compose.yml используется для запуска всех микросервисов, docker-compose-dev используется для поднятия необходимых сервисов для разработки(кафка, база и прочее)
- для пользователей, которые не совершали звонки, но имеют тариф с помесячной оплатой, есть специальная проверка (крон задача), которая проверяет все неоплаченные месяца
- почти к каждому методу в коде есть пояснения или небольшая дока

# Правила добавления нового тарифа
### Есть 3 таблицы

- trariffs
- tariffs_minutes
- tariffs_call_limits

* В таблице trariffs заполняется общная информация о тарифе
* В таблице tariffs_minutes заполняется информация информация о бесплатных минутах в рамках одного месяца. 
Стоит учесть, что флаг commonMinutes отвечает за то, что входящие и исходящие звонки считаются как одно целое
* В таблице tariffs_call_limits заполняется информация о стоимости звонков (в *WithoutPacket указывается цена, если человек превысил свои лимиты или не имеет помесячной оплаты)